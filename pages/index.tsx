import { Box, Button, Center, Heading, Spinner, Stack, Text } from '@chakra-ui/react';
import dayjs from 'dayjs';
import Head from 'next/head';
import { useEffect, useState } from 'react';
import { ConferenceDay, Layout } from '../components';
import { criteria, filterBy } from '../utils';

const Home = () => {
  const [selectedDay, setSelectedDay] = useState(1);
  const [results, setResults] = useState([]);
  const [loading, setLoading] = useState(true);
  const date = selectedDay === 1 ? '2020-04-17' : selectedDay === 2 ? '2020-04-18' : '2020-04-19';

  const fetchAPI = async () => {
    const res = await fetch(process.env.NEXT_PUBLIC_BASE_URL ?? '');
    const { next, results } = await res.json();
    let nextResults = [];

    if (next) {
      const nextResponse = await fetch(`${process.env.NEXT_PUBLIC_BASE_URL}?offset=25`);
      const { results } = await nextResponse.json();
      nextResults = results;
    }

    const finalResults = next ? results.concat(nextResults).sort(criteria) : results.sort(criteria);
    setResults(finalResults);
    setLoading(false);
  };

  useEffect(() => {
    fetchAPI();
  }, []);

  return (
    <>
      <Head>
        <title>Devcon Schedule</title>
        <meta name='description' content='Generated by create next app' />
        <link rel='icon' href='/favicon.ico' />
      </Head>

      <Box
        backgroundImage="url('/ethereum-org-hero.png')"
        backgroundPosition='center'
        backgroundRepeat='no-repeat'
        opacity={0.16}
        h={96}
        zIndex={-1}
        mb={-96}
      />

      <Layout>
        <main>
          <Stack mb={24}>
            <Stack
              direction='row'
              justifyContent='center'
              alignItems='center'
              marginTop={24}
              marginBottom={16}
            >
              <Heading as='h1' size='3xl'>
                Schedule
              </Heading>
            </Stack>

            <Stack>
              <Stack direction='row' spacing={6} justifyContent='center' mb={12}>
                <Button onClick={() => setSelectedDay(1)} isActive={selectedDay === 1}>
                  Day 1
                </Button>
                <Button onClick={() => setSelectedDay(2)} isActive={selectedDay === 2}>
                  Day 2
                </Button>
                <Button onClick={() => setSelectedDay(3)} isActive={selectedDay === 3}>
                  Day 3
                </Button>
              </Stack>

              <Stack>
                <Text textAlign='right' fontSize='2xl'>
                  {dayjs(
                    selectedDay === 1
                      ? '2020-04-17'
                      : selectedDay === 2
                      ? '2020-04-18'
                      : '2020-04-19'
                  ).format('MMMM D, YYYY')}
                </Text>
              </Stack>
            </Stack>
          </Stack>

          <Stack mb={12}>
            <Stack mb={16}>
              <Stack direction='row' justifyContent='center' marginTop={6} marginBottom={12}>
                <Heading as='h2' size='lg'>
                  Magenta Room
                </Heading>
              </Stack>
              {loading ? (
                <Center>
                  <Spinner />
                </Center>
              ) : (
                <ConferenceDay results={filterBy(results, date, 'Magenta Room')} />
              )}
            </Stack>

            <Stack>
              <Stack direction='row' justifyContent='center' marginTop={6} marginBottom={12}>
                <Heading as='h2' size='lg'>
                  Khaki Room
                </Heading>
              </Stack>
              {loading ? (
                <Center>
                  <Spinner />
                </Center>
              ) : (
                <ConferenceDay results={filterBy(results, date, 'Khaki Room')} />
              )}
            </Stack>
          </Stack>
        </main>
      </Layout>
    </>
  );
};

export default Home;
